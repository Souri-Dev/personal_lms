{% extends 'base.html.twig' %}

{% block body %}
	<h2>Take Attendance for
		{{ section.sectionName }}
		({{ section.class.subjectName }})</h2>

	<div id="qr-reader" style="width: 300px;"></div>
	<div id="qr-result" class="mt-3"></div>

	<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

	<script>
		const qrReader = new Html5Qrcode("qr-reader");

function onScanSuccess(decodedText, decodedResult) { // Show QR text
document.getElementById("qr-result").innerText = "QR: " + decodedText;

// Send QR to Symfony backend
fetch('{{ path("mark_attendance") }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify(
{qr: decodedText, sectionId: {{ section.id }}}
)
}).then(response => response.json()).then(data => {
if (data.success) {
alert(data.message);
} else {
alert("Error: " + data.message);
}
}).catch(console.error);

// Stop scanner after one scan (optional)
qrReader.stop().then(() => {
console.log("QR scanner stopped.");
});
}

Html5Qrcode.getCameras().then(cameras => {
if (cameras.length > 0) {
qrReader.start({
facingMode: "environment"
}, {
fps: 10,
qrbox: 250
}, onScanSuccess);
}
});
	</script>
{% endblock %}
