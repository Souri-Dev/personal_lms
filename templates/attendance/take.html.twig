{% extends 'layouts/vertical.html.twig' %}

{% set title = 'Take Attendance' %}

{% block content %}
	<div class="container-fluid">
		<div class="py-3 d-flex align-items-sm-center flex-sm-row flex-column">
			<div class="flex-grow-1">
				<h4 class="fs-18 fw-semibold m-0">
					Take Attendance for Section
					{{ section.sectionName }}
					({{ section.class.subjectName }})
				</h4>
			</div>
			<div class="text-end">
				<ol class="breadcrumb m-0 py-0">
					<li class="breadcrumb-item">
						<a href="javascript:void(0);">Dashboard</a>
					</li>
					<li class="breadcrumb-item active">Take Attendance</li>
				</ol>
			</div>
		</div>

		<div
			class="row">
			<!-- Camera column -->
			<div class="col-md-6 mb-4">
				<div id="qr-reader" style="width: 100%; height: auto;"></div>
				<div id="qr-result" class="mt-3 text-success fw-semibold"></div>
			</div>

			<!-- Attendance logs column -->
			<div class="col-md-6">
				<h5 class="fw-bold mb-3">Today's Attendance</h5>
				<ul id="attendance-log-list" class="list-group">
					{% for attendance in attendanceLogs %}
						<li class="list-group-item d-flex justify-content-between align-items-center">
							{{ attendance.student.name }}
							<span class="badge bg-success">{{ attendance.date|date('h:i A') }}</span>
						</li>
					{% else %}
						<li class="list-group-item text-muted">No attendance records for today.</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>

	<!-- Success Modal -->
	<div class="modal fade" id="successModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Attendance Mark</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="successModalBody"></div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

{% endblock %}

{% block script %}
	<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
	<script>
		const qrReader = new Html5Qrcode("qr-reader");
const sectionId = {{ section.id }};
const qrResultDiv = document.getElementById("qr-result");
const attendanceList = document.getElementById("attendance-log-list");

function fetchAttendanceLogs() {
fetch (`/section/${sectionId}/attendance-logs`).then(response => response.json()).then(data => {
attendanceList.innerHTML = "";

if (data.attendanceLogs.length === 0) {
attendanceList.innerHTML = '<li class="list-group-item text-muted">No attendance records for today.</li>';
} else {
data.attendanceLogs.forEach(log => {
const li = document.createElement("li");
li.className = "list-group-item d-flex justify-content-between align-items-center";
li.innerHTML = `
							${
log.studentName
}
							<span class="badge bg-success">${
log.time
}</span>
						`;
attendanceList.appendChild(li);
});
}
}).catch(err => console.error("Failed to fetch logs:", err));
}

function onScanSuccess(decodedText, decodedResult) {
qrReader.stop().then(() => {
console.log("QR scanning stopped temporarily.");

qrResultDiv.innerText = "QR: " + decodedText;

fetch('{{ path("mark_attendance") }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'X-Requested-With': 'XMLHttpRequest'
},
body: JSON.stringify(
{qr: decodedText, sectionId: sectionId}
)
}).then(response => response.json()).then(data => {
document.getElementById('successModalBody').innerText = data.message;

const successModal = new bootstrap.Modal(document.getElementById('successModal'));
successModal.show();

fetchAttendanceLogs();

// Resume scanning after a short delay (optional)
setTimeout(() => startScanner(), 2000);
}).catch(error => {
console.error("Error:", error);
alert("An error occurred while marking attendance.");
setTimeout(() => startScanner(), 2000);
});
}).catch(err => console.error("Failed to stop scanner:", err));
}

function startScanner() {
Html5Qrcode.getCameras().then(cameras => {
if (cameras.length > 0) {
qrReader.start({
facingMode: "environment"
}, {
fps: 10,
qrbox: 250
}, onScanSuccess).catch(err => console.error("Scanner start failed:", err));
}
}).catch(err => console.error("Camera access error:", err));
}

// Initial load
startScanner();
fetchAttendanceLogs();
	</script>
{% endblock %}
